# Opponent card tracking rules
Purpose: define data model and heuristics for opponent:seen command across live and batch modes.

## Event sources
- GRE `GameStateChange` and `CardsDrawn` events for cards revealed, drawn, or played
- `ZoneChange` events moving cards to battlefield, graveyard, exile, stack
- `PlayerMessage` logs capturing companion-revealed cards (companions, learn, etc.)

## Tracking lifecycle
1. Match start: initialize opponent tracker with empty zones and metadata (player ID, archetype inference placeholder)
2. Card observation: when card enters opponent hand, battlefield, stack, or exile from library, record card identity and timestamp
3. Resets: phase-based resets not required; track across entire match
4. Duplicate handling: maintain counts per card, increment on multiple observations within same match
5. Split cards/adventures: store composite ID and display canonical name with mode indicator

## Aggregation modes
- Per-match (default): list cards grouped by match with counts, zones seen, and first/last seen timestamps
- Aggregated (`--group-by card`): sum occurrences across matches, include number of matches where card appeared
- Time filters: `--since`, `--from`, `--to` restricted by match end timestamps

## Special cases
- Hidden information (e.g., cards discarded unseen): do not record unless log reveals card name
- Double-faced cards: report front face name; include `transform_face` metadata in JSON
- Tokens generated by opponent: include type but mark as token with `is_token: true`
- Conceded matches with incomplete logs: flag match as partial and exclude from aggregated stats unless data confidence â‰¥80%

## Output schema (JSON)
```json
{
  "matches": [
    {
      "id": "match-001",
      "opponent": {"screen_name": "Mage123", "archetype": "Esper Control"},
      "cards": [
        {"name": "Thoughtseize", "count": 2, "zones": ["hand", "stack"], "first_seen": "2025-10-08T01:10:02Z"}
      ],
      "confidence": 1.0
    }
  ],
  "aggregated": [
    {"name": "Thoughtseize", "matches": 5, "total_count": 7}
  ]
}
```

## CLI formatting
- Default: table per match with columns Card, Count, Zones, First Seen, Last Seen
- Aggregated: table with Card, Matches, Total Count, Last Seen
- Provide `--json` to emit schema above; `--out` writes to file

## Testing strategy
- Integration fixtures covering aggro, control, token-heavy archetypes
- Edge-case tests for split/adventure cards, tokens, partial logs, and alternate win conditions
- Snapshot tests verifying CLI tables for both modes
